{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    .sidebar { height: 90vh; overflow-y: auto; border-right: 1px solid #ddd; }
    .chat-window { height: 75vh; overflow-y: auto; background: #f8f9fa; padding: 16px; border-radius: 6px; }
    .msg-sent { text-align: right; margin-bottom: 12px; }
    .msg-recv { text-align: left; margin-bottom: 12px; }
    .bubble { display: inline-block; padding: 10px 14px; border-radius: 14px; max-width: 70%; }
    .bubble.sent { background: #dcf8c6; }
    .bubble.recv { background: #fff; border: 1px solid #eee; }
    .chat-image { max-width: 250px; border-radius: 10px; display: block; margin-top: 8px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-3 sidebar p-3">
      <h5>Contacts</h5>
      <input id="contactSearch" class="form-control mb-2" placeholder="Search number or name">
      <ul id="contactList" class="list-group">
        {% for item in mobile_list %}
          <li class="list-group-item contact-item" data-mobile="{{ item.mobile }}">{{ item.mobile }}</li>
        {% empty %}
          <li class="list-group-item">No contacts yet</li>
        {% endfor %}
      </ul>
    </div>

    <div class="col-9 p-3">
      <div id="chatHeader" class="mb-2"><strong>Select a contact</strong></div>

      <div id="chatWindow" class="chat-window mb-3">
        <div id="emptyHint" class="text-muted">No conversation selected.</div>
      </div>

      <div id="composer" style="display:none;">
        <div class="input-group">
          <input id="messageInput" type="text" class="form-control" placeholder="Type a message...">
          <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function () {
  let selectedMobile = null;
  let pollInterval = null;

  function setActiveContact(el) {
    $('.contact-item').removeClass('active');
    el.addClass('active');
  }

  function renderMessages(messages) {
    const container = $('#chatWindow');
    container.empty();
    if (!messages.length) {
      container.append('<div class="text-muted">No messages for this number yet.</div>');
      return;
    }

    messages.forEach(msg => {
      let dt = new Date(msg.sent_at);
      let time = dt.toLocaleString();
      let content = "";

      // âœ… Media rendering â€” use msg.media_file directly (full URL from backend)
      if (msg.content_type === "image" && msg.media_file) {
        content = `
          ${msg.sent_text_message ? escapeHtml(msg.sent_text_message) + "<br>" : ""}
          <img src="${msg.media_file}" class="chat-image" alt="Image message">
        `;
      } else if (msg.content_type === "document" && msg.media_file) {
        content = `
          ${msg.sent_text_message ? escapeHtml(msg.sent_text_message) + "<br>" : ""}
          <a href="${msg.media_file}" target="_blank">ðŸ“„ View Document</a>
        `;
      } else if (msg.content_type === "audio" && msg.media_file) {
        content = `<audio controls><source src="${msg.media_file}" type="audio/mpeg"></audio>`;
      } else if (msg.content_type === "video" && msg.media_file) {
        content = `<video controls width="250"><source src="${msg.media_file}" type="video/mp4"></video>`;
      } else {
        content = escapeHtml(msg.sent_text_message);
      }

      const bubbleClass = msg.message_type === 'Sent' ? 'sent' : 'recv';
      const alignClass = msg.message_type === 'Sent' ? 'msg-sent' : 'msg-recv';

      container.append(`
        <div class="${alignClass}">
          <div class="bubble ${bubbleClass}">
            ${content}
            <div class="text-muted small">${time}</div>
          </div>
        </div>
      `);
    });
    container.scrollTop(container[0].scrollHeight);
  }

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe.replace(/[&<"']/g, m => ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function fetchMessages(mobile) {
    if (!mobile) return;
    $.getJSON(`/api/messages/${encodeURIComponent(mobile)}/`, function (data) {
      renderMessages(data.messages || []);
    });
  }

  function startPolling(mobile) {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => fetchMessages(mobile), 3000);
  }

  $(document).on('click', '.contact-item', function () {
    const mobile = $(this).data('mobile');
    selectedMobile = mobile;
    setActiveContact($(this));
    $('#chatHeader').html(`<strong>${mobile}</strong>`);
    $('#composer').show();
    $('#emptyHint').remove();
    fetchMessages(mobile);
    startPolling(mobile);
  });

  $('#sendBtn').on('click', function () {
    const text = $('#messageInput').val().trim();
    if (!text || !selectedMobile) return;
    const payload = { mobile: selectedMobile, text: text };
    $.ajax({
      url: '/api/send-reply/',
      method: 'POST',
      headers: {'X-CSRFToken': window.CSRF_TOKEN},
      data: JSON.stringify(payload),
      contentType: 'application/json',
      success: function () {
        $('#messageInput').val('');
        fetchMessages(selectedMobile);
      },
      error: function (err) {
        alert('Error sending message: ' + (err.responseJSON?.error || 'unknown'));
      }
    });
  });

  $('#contactSearch').on('input', function () {
    const q = $(this).val().toLowerCase();
    $('.contact-item').each(function () {
      const mobile = $(this).data('mobile').toString().toLowerCase();
      $(this).toggle(mobile.indexOf(q) !== -1);
    });
  });
})();
</script>

<script>
  window.CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
</script>
</body>
</html>
